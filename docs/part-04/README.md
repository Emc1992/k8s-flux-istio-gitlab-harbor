# Flux image operations

Set the namespace (`flux`) where flux was installed for running `fluxctl`:

```bash
export FLUX_FORWARD_NAMESPACE=flux
```

Install [podinfo](https://github.com/stefanprodan/podinfo) application using
Flux:

```bash
envsubst << EOF > tmp/k8s-flux-repository/workloads/podinfo.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: podinfo
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: podinfo
  template:
    metadata:
      labels:
        app: podinfo
    spec:
      containers:
      - name: podinfo
        image: "stefanprodan/podinfo:2.1.2"
        ports:
        - containerPort: 9898
---
apiVersion: v1
kind: Service
metadata:
  name: podinfo-service
  namespace: default
  labels:
    app: podinfo
spec:
  type: ClusterIP
  selector:
    app: podinfo
  ports:
  - name: podinfo-http
    port: 9898
    protocol: TCP
    targetPort: 9898
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: podinfo-http-virtual-service
  namespace: default
spec:
  hosts:
  - podinfo.${MY_DOMAIN}
  gateways:
  - istio-system/istio-autogenerated-k8s-ingress
  http:
  - route:
    - destination:
        host: podinfo-service.default.svc.cluster.local
        port:
          number: 9898
EOF
```

Add it to the git repository and let Flux to deploy the application:

```bash
git -C tmp/k8s-flux-repository add --verbose .
git -C tmp/k8s-flux-repository commit -m "Add podinfo"
git -C tmp/k8s-flux-repository push -q
fluxctl sync
sleep 40
```

Output:

```text
add 'workloads/podinfo.yaml'
[master 2328c1a] Add podinfo
 1 file changed, 72 insertions(+)
 create mode 100644 workloads/podinfo.yaml
Synchronizing with git@github.com:ruzickap/k8s-flux-repository
Revision of master to apply is 2328c1a
Waiting for 2328c1a to be applied ...
Done.
```

```bash
curl http://podinfo.mylabs.dev
if [ -x /usr/bin/chromium-browser ]; then chromium-browser https://podinfo.mylabs.dev & fi
```

Output:

```json
{
  "hostname": "podinfo-56c6447655-mc7kp",
  "version": "2.1.2",
  "revision": "ab74d6ef0bd3c5f39090134f59b12837757e80b8",
  "color": "blue",
  "message": "greetings from podinfo v2.1.2",
  "goos": "linux",
  "goarch": "amd64",
  "runtime": "go1.12.7",
  "num_goroutine": "6",
  "num_cpu": "2"
}
```

::: tip
Workloads refers to any cluster resource responsible for the creation
of containers from versioned images - in Kubernetes these are objects such as
Deployments, DaemonSets, StatefulSets and CronJobs.
:::

Check whether Flux can see any running workloads:

```bash
fluxctl list-workloads
```

Output:

```text
WORKLOAD                    CONTAINER  IMAGE                       RELEASE  POLICY
default:deployment/podinfo  podinfo    stefanprodan/podinfo:2.1.2  ready
```

Inspect which versions of the image are running in the workload:

```bash
fluxctl list-images --workload default:deployment/podinfo 2>/dev/null
```

Output:

```text
WORKLOAD                    CONTAINER  IMAGE                 CREATED
default:deployment/podinfo  podinfo    stefanprodan/podinfo
                                       |   2.1.3             13 Aug 19 09:33 UTC
                                       |   latest            13 Aug 19 09:33 UTC
                                       '-> 2.1.2             13 Aug 19 07:53 UTC
                                           2.1.1             13 Aug 19 07:51 UTC
                                           2.1.0             07 Aug 19 13:18 UTC
                                           2.0.5             07 Aug 19 12:50 UTC
                                           2.0.4             07 Aug 19 12:48 UTC
                                           2.0.3             07 Aug 19 12:45 UTC
                                           2.0.2             07 Aug 19 12:41 UTC
                                           2.0.1             07 Aug 19 12:39 UTC
```

```bash
fluxctl release --workload=default:deployment/podinfo --user=pruzicka --message="New version" --update-all-images
```

Output:

```text
Submitting release ...
WORKLOAD                    STATUS   UPDATES
default:deployment/podinfo  success  podinfo: stefanprodan/podinfo:2.1.2 -> 2.1.3
Commit pushed:  87989e5
Commit applied: 87989e5
```

```bash
fluxctl list-images --workload default:deployment/podinfo 2>/dev/null
```

Output:

```text
WORKLOAD                    CONTAINER  IMAGE                 CREATED
default:deployment/podinfo  podinfo    stefanprodan/podinfo
                                       '-> 2.1.3             13 Aug 19 09:33 UTC
                                           latest            13 Aug 19 09:33 UTC
                                           2.1.2             13 Aug 19 07:53 UTC
                                           2.1.1             13 Aug 19 07:51 UTC
...
```

```bash
kubectl describe pods | grep Image:
```

Output:

```text
    Image:          stefanprodan/podinfo:2.1.3
```

## Turning on Automation

```bash
fluxctl automate --workload=default:deployment/podinfo
```

Output:

```text
WORKLOAD                    STATUS   UPDATES
default:deployment/podinfo  success
Commit pushed:  99dd0ba
```

Flux will now automatically deploy a new version of a workload whenever one is
available and commit the new configuration to the version control system.

```bash
fluxctl list-workloads
```

Output:

```text
WORKLOAD                    CONTAINER  IMAGE                       RELEASE  POLICY
default:deployment/podinfo  podinfo    stefanprodan/podinfo:2.1.3  ready    automated
```

## Rolling back a workload

```bash
fluxctl deautomate --workload=default:deployment/podinfo
```

Output:

```text
WORKLOAD                    STATUS   UPDATES
default:deployment/podinfo  success
Commit pushed:  806a45b
```

```bash
fluxctl release --workload=default:deployment/podinfo --update-image=stefanprodan/podinfo:2.1.2
```

Output:

```text
Submitting release ...
WORKLOAD                    STATUS   UPDATES
default:deployment/podinfo  success  podinfo: stefanprodan/podinfo:2.1.3 -> 2.1.2
Commit pushed:  a0f8e97
Commit applied: a0f8e97
```

```bash
fluxctl list-images --workload=default:deployment/podinfo 2>/dev/null
```

Output:

```text
WORKLOAD                    CONTAINER  IMAGE                 CREATED
default:deployment/podinfo  podinfo    stefanprodan/podinfo
                                       |   2.1.3             13 Aug 19 09:33 UTC
                                       |   latest            13 Aug 19 09:33 UTC
                                       '-> 2.1.2             13 Aug 19 07:53 UTC
                                           2.1.1             13 Aug 19 07:51 UTC
...
```

## Image Tag Filtering

```bash
fluxctl policy --workload=default:deployment/podinfo --tag-all='2.0.*'
```

```text
WORKLOAD                    STATUS   UPDATES
default:deployment/podinfo  success
Commit pushed:  38d94be
```

```bash
git -C tmp/k8s-flux-repository pull -q
git -C tmp/k8s-flux-repository show
```

Output:

```text
commit 38d94be23eec28b9477b799f100d393a806c9085 (HEAD -> master, tag: flux-sync, origin/master)
Author: Flux <petr.ruzicka@gmail.com>
Date:   Thu Aug 22 12:45:03 2019 +0000

    Updated policies: default:deployment/podinfo

─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
modified: workloads/podinfo.yaml
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
@ workloads/podinfo.yaml:7 @ kind: Deployment
metadata:
  name: podinfo
  namespace: default
  annotations:
    flux.weave.works/tag.podinfo: glob:2.0.*
spec:
  replicas: 1
  selector:
```

```bash
fluxctl release --workload=default:deployment/podinfo --update-all-images
```

Output:

```text
Submitting release ...
WORKLOAD                    STATUS   UPDATES
default:deployment/podinfo  success  podinfo: stefanprodan/podinfo:2.1.2 -> 2.0.5
Commit pushed:  af27a35
Commit applied: af27a35
```

## Automated container image installation

```bash
if [ -x /usr/bin/chromium-browser ]; then chromium-browser https://harbor.mylabs.dev & fi
```

```bash
envsubst << EOF > tmp/k8s-flux-repository/workloads/kuard.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kuard
  namespace: default
  annotations:
    flux.weave.works/automated: "true"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kuard
  template:
    metadata:
      labels:
        app: kuard
    spec:
      containers:
      - name: kuard
        image: "harbor.${MY_DOMAIN}/library/kuard:v1"
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: kuard-service
  namespace: default
  labels:
    app: kuard
spec:
  type: ClusterIP
  selector:
    app: kuard
  ports:
  - name: kuard-http
    port: 8080
    protocol: TCP
    targetPort: 8080
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: kuard-http-virtual-service
  namespace: default
spec:
  hosts:
  - kuard.${MY_DOMAIN}
  gateways:
  - istio-system/istio-autogenerated-k8s-ingress
  http:
  - route:
    - destination:
        host: kuard-service.default.svc.cluster.local
        port:
          number: 8080
EOF
```

Add it to the git repository and let Flux to deploy the application:

```bash
git -C tmp/k8s-flux-repository pull -q
git -C tmp/k8s-flux-repository add --verbose .
git -C tmp/k8s-flux-repository commit -m "Add kuard"
git -C tmp/k8s-flux-repository push -q
fluxctl sync
```

Output:

```text
Synchronizing with git@github.com:ruzickap/k8s-flux-repository
Revision of master to apply is 55c3ba2
Waiting for 55c3ba2 to be applied ...
Done.
```

```bash
COUNTER=0; while [ $COUNTER -lt 8 ] ; do COUNTER=$((COUNTER+1)); fluxctl list-images --workload default:deployment/kuard 2>/dev/null; sleep 5; done
```

Output:

```text
WORKLOAD                  CONTAINER  IMAGE                            CREATED
default:deployment/kuard  kuard      harbor.mylabs.dev/library/kuard
                                     '-> v1                           23 Aug 19 12:50 UTC
```

```bash
if [ -x /usr/bin/chromium-browser ]; then chromium-browser https://kuard.mylabs.dev & fi
```

Change the version

```bash
sed -i "s/ENV VERSION=test/ENV VERSION=new_version/" tmp/kuard/Dockerfile
```

Build [kuard](https://github.com/kubernetes-up-and-running/kuard) container
image and push it to `harbor.mylabs.dev/library/kuard:v2`:

```bash
docker build --tag harbor.${MY_DOMAIN}/library/kuard:v2 tmp/kuard
echo admin | docker login --username admin --password-stdin harbor.${MY_DOMAIN}
docker push harbor.${MY_DOMAIN}/library/kuard:v2
```

```bash
COUNTER=0; while [ $COUNTER -lt 12 ] ; do COUNTER=$((COUNTER+1)); fluxctl list-images --workload default:deployment/kuard 2>/dev/null; sleep 5; done
```

Output:

```text
WORKLOAD                  CONTAINER  IMAGE                            CREATED
default:deployment/kuard  kuard      harbor.mylabs.dev/library/kuard
                                     '-> v2                           23 Aug 19 13:08 UTC
                                         v1                           23 Aug 19 12:50 UTC
```

## Remove the applications using git commit

See the running pods:

```bash
kubectl get virtualservice,service,deployment,pods
```

Output:

```text
```

Check the git repository:

```bash
date
git -C tmp/k8s-flux-repository pull -q
git -C tmp/k8s-flux-repository show
```

Let's remove the `podinfo` and `kuard` application:

```bash
rm tmp/k8s-flux-repository/workloads/podinfo.yaml tmp/k8s-flux-repository/workloads/kuard.yaml
git -C tmp/k8s-flux-repository add --verbose .
git -C tmp/k8s-flux-repository commit -m "Remove podinfo and kuard"
git -C tmp/k8s-flux-repository push -q
fluxctl sync
```

Check the pods - Flux should remove the `podinfo` pod:

```bash
kubectl get virtualservice,service,deployment,pods
```

Output:

```text
```
