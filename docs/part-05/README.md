# Flux Helm Chart operations

Demo of the HelmRelease operations and Flux

## Install GitLab using flux

Install GitLab

```bash
envsubst < files/flux-repository/namespaces/gitlab-ns.yaml                          > tmp/k8s-flux-repository/namespaces/gitlab-ns.yaml
envsubst < files/flux-repository/releases/gitlab-release.yaml                       > tmp/k8s-flux-repository/releases/gitlab-release.yaml
envsubst < files/flux-repository/workloads/gitlab-custom-ca.yaml                    > tmp/k8s-flux-repository/workloads/gitlab-custom-ca.yaml
envsubst < files/flux-repository/workloads/gitlab-gitlab-initial-root-password.yaml > tmp/k8s-flux-repository/workloads/gitlab-gitlab-initial-root-password.yaml
envsubst < files/flux-repository/workloads/gitlab-services.yaml                     > tmp/k8s-flux-repository/workloads/gitlab-services.yaml

git -C tmp/k8s-flux-repository add --verbose .
git -C tmp/k8s-flux-repository commit -m "Add GitLab"
git -C tmp/k8s-flux-repository push -q
fluxctl sync
```

## Run and application via Flux "HelmRelease"

Create `HelmRelease` and `VirtualService` files:

```bash
envsubst << EOF > tmp/k8s-flux-repository/releases/podinfo-release.yaml
apiVersion: flux.weave.works/v1beta1
kind: HelmRelease
metadata:
  name: podinfo
  namespace: default
  annotations:
    flux.weave.works/automated: "false"
spec:
  releaseName: podinfo
  targetNamespace: default
  chart:
    repository: https://stefanprodan.github.io/podinfo
    name: podinfo
    version: 2.1.1
  values:
    service:
      enabled: true
    color: green
    message: Hello from
EOF

envsubst << EOF > tmp/k8s-flux-repository/workloads/podinfo.yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: podinfo-http-virtual-service
  namespace: default
spec:
  hosts:
  - podinfo.${MY_DOMAIN}
  gateways:
  - istio-system/istio-autogenerated-k8s-ingress
  http:
  - route:
    - destination:
        host: podinfo.default.svc.cluster.local
        port:
          number: 9898
EOF
```

Push the changes to the Git repository:

```bash
git -C tmp/k8s-flux-repository add --verbose .
git -C tmp/k8s-flux-repository commit -m "Add podinfo HelmRelease"
git -C tmp/k8s-flux-repository push -q
fluxctl sync
sleep 20
```

```bash
helm ls
```

Output:

```text
NAME            REVISION        UPDATED                         STATUS          CHART                   APP VERSION     NAMESPACE
...
podinfo         1               Mon Aug 26 19:26:04 2019        DEPLOYED        podinfo-2.1.1           2.1.1           default
```

```bash
helm history podinfo
```

Output:

```text
REVISION        UPDATED                         STATUS          CHART           DESCRIPTION
1               Mon Aug 26 19:26:04 2019        DEPLOYED        podinfo-2.1.1   Install complete
```

```bash
kubectl describe helmreleases.flux.weave.works podinfo
```

Output:

```text
Name:         podinfo
Namespace:    default
Labels:       flux.weave.works/sync-gc-mark=sha256.grAYAKjn3uQ_4t8EXwcBCfJndY8XeUwdNz_dOeTJTcs
Annotations:  flux.weave.works/automated: false
              flux.weave.works/sync-checksum: d8863913a7ae9a9f8901f7622285dda7c47fdcc7
              kubectl.kubernetes.io/last-applied-configuration:
                {"apiVersion":"flux.weave.works/v1beta1","kind":"HelmRelease","metadata":{"annotations":{"flux.weave.works/automated":"false","flux.weave....
API Version:  flux.weave.works/v1beta1
Kind:         HelmRelease
Metadata:
  Creation Timestamp:  2019-08-26T17:26:04Z
  Generation:          2
  Resource Version:    18628
  Self Link:           /apis/flux.weave.works/v1beta1/namespaces/default/helmreleases/podinfo
  UID:                 94ff3e40-c826-11e9-88de-025b937076da
Spec:
  Chart:
    Name:            podinfo
    Repository:      https://stefanprodan.github.io/podinfo
    Version:         2.1.1
  Release Name:      podinfo
  Target Namespace:  default
  Values:
    Color:              green
    Service . Enabled:  true
Status:
  Conditions:
    Last Transition Time:  2019-08-26T17:26:05Z
    Last Update Time:      2019-08-26T17:44:54Z
    Message:               helm upgrade succeeded
    Reason:                HelmSuccess
    Status:                True
    Type:                  Released
    Last Transition Time:  2019-08-26T17:26:04Z
    Last Update Time:      2019-08-26T17:56:53Z
    Message:               chart fetched: podinfo-2.1.1.tgz
    Reason:                RepoChartInCache
    Status:                True
    Type:                  ChartFetched
  Observed Generation:     2
  Release Name:            podinfo
  Release Status:          DEPLOYED
  Revision:                2.1.1
  Values Checksum:         e5cbd0fbdaec53c94a85d00d87df06fd9a4140d603ff68418422de5dcbd7c849
Events:
  Type    Reason       Age                   From           Message
  ----    ------       ----                  ----           -------
  Normal  ChartSynced  2m55s (x13 over 33m)  helm-operator  Chart managed by HelmRelease processed
```

```bash
kubectl get pods
```

Output:

```text
NAME                       READY   STATUS    RESTARTS   AGE
podinfo-7c9b8ddf75-xjpnw   1/1     Running   0          4m57s
```

```bash
kubectl describe pods | grep Image:
```

Output:

```text
    Image:         stefanprodan/podinfo:2.1.1
```

```bash
fluxctl list-workloads -n default
```

Output:

```text
WORKLOAD                     CONTAINER  IMAGE                               RELEASE   POLICY
default:deployment/podinfo   podinfo    stefanprodan/podinfo:2.1.1          ready
default:helmrelease/podinfo                                                 DEPLOYED
```

```bash
fluxctl list-images -n default 2>/dev/null
```

```bash
sed -i "s/version: 2.1.1/version: 2.1.3/" tmp/k8s-flux-repository/releases/podinfo-release.yaml
git -C tmp/k8s-flux-repository add --verbose .
git -C tmp/k8s-flux-repository commit -m "Increase podinfo Helm version"
git -C tmp/k8s-flux-repository push -q
fluxctl sync
```

List the release history of `podinfo`:

```bash
helm history podinfo
```

Output:

```text
REVISION        UPDATED                         STATUS          CHART           DESCRIPTION
1               Mon Aug 26 19:26:04 2019        SUPERSEDED      podinfo-2.1.1   Install complete
2               Mon Aug 26 19:44:54 2019        SUPERSEDED      podinfo-2.1.1   Upgrade complete
3               Mon Aug 26 20:23:56 2019        DEPLOYED        podinfo-2.1.3   Upgrade complete
```

Check the `HelmRelease` details:

```bash
kubectl describe helmreleases.flux.weave.works podinfo
```

Output:

```text
Name:         podinfo
Namespace:    default
Labels:       flux.weave.works/sync-gc-mark=sha256.grAYAKjn3uQ_4t8EXwcBCfJndY8XeUwdNz_dOeTJTcs
Annotations:  flux.weave.works/automated: false
              flux.weave.works/sync-checksum: e85bf3e0928c61c99dbdb32d8cd70a1f1c660ec7
              kubectl.kubernetes.io/last-applied-configuration:
                {"apiVersion":"flux.weave.works/v1beta1","kind":"HelmRelease","metadata":{"annotations":{"flux.weave.works/automated":"false","flux.weave....
API Version:  flux.weave.works/v1beta1
Kind:         HelmRelease
Metadata:
  Creation Timestamp:  2019-08-26T17:26:04Z
  Generation:          3
  Resource Version:    23347
  Self Link:           /apis/flux.weave.works/v1beta1/namespaces/default/helmreleases/podinfo
  UID:                 94ff3e40-c826-11e9-88de-025b937076da
Spec:
  Chart:
    Name:            podinfo
    Repository:      https://stefanprodan.github.io/podinfo
    Version:         2.1.3
  Release Name:      podinfo
  Target Namespace:  default
  Values:
    Color:              green
    Service . Enabled:  true
Status:
  Conditions:
    Last Transition Time:  2019-08-26T17:26:05Z
    Last Update Time:      2019-08-26T18:23:57Z
    Message:               helm upgrade succeeded
    Reason:                HelmSuccess
    Status:                True
    Type:                  Released
    Last Transition Time:  2019-08-26T17:26:04Z
    Last Update Time:      2019-08-26T18:32:51Z
    Message:               chart fetched: podinfo-2.1.3.tgz
    Reason:                RepoChartInCache
    Status:                True
    Type:                  ChartFetched
  Observed Generation:     3
  Release Name:            podinfo
  Release Status:          DEPLOYED
  Revision:                2.1.3
  Values Checksum:         e5cbd0fbdaec53c94a85d00d87df06fd9a4140d603ff68418422de5dcbd7c849
Events:
  Type    Reason       Age                   From           Message
  ----    ------       ----                  ----           -------
  Normal  ChartSynced  2m13s (x26 over 68m)  helm-operator  Chart managed by HelmRelease processed
```

Check the Helm Charts:

```bash
helm ls
```

Output:

```text
```

Let's remove the podinfo Helm chart:

```bash
rm tmp/k8s-flux-repository/releases/podinfo-release.yaml
git -C tmp/k8s-flux-repository add --verbose .
git -C tmp/k8s-flux-repository commit -m "Remove podinfo Helm Chart"
git -C tmp/k8s-flux-repository push -q
fluxctl sync
```

Check the Helm Charts:

```bash
helm ls
```

Output:

```text
```

## GitLab upgrade

Open the GitLab URL ( `root` / `admin123` ) and check the version (`12.2.0`)
in the "Admin" area:

* [https://gitlab.mylabs.dev](https://gitlab.mylabs.dev), [http://gitlab.mylabs.dev](http://gitlab.mylabs.dev)
* `ssh://gitlab.mylabs.dev`

```bash
if [ -x /usr/bin/chromium-browser ]; then chromium-browser https://gitlab.mylabs.dev & fi
```

Upgrade GitLab to version `12.2.1`:

```bash
sed -i "s/version: 2.2.0/version: 2.2.1/" tmp/k8s-flux-repository/releases/gitlab-release.yaml
git -C tmp/k8s-flux-repository add --verbose .
git -C tmp/k8s-flux-repository commit -m "Increase GitLab Helm version"
git -C tmp/k8s-flux-repository push -q
fluxctl sync
COUNTER=0; while [ $COUNTER -lt 20 ] ; do COUNTER=$((COUNTER+1)); kubectl get pods -n gitlab ; sleep 10; done
```

Verify if all the GitLab pods are running:

```bash
kubectl get pods -n gitlab
```

Then verify the GitLab version again (should be `12.2.1`).

```bash
helm ls
```
